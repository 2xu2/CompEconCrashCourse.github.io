<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CompEconUMN2024 - Firm dynamics with an example of exporter dynamics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">CompEconUMN2024</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-julia-lectures" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Julia Lectures</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-julia-lectures">    
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_1_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_2_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_3_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_4_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_5_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Lectures/Julia_Lec_6_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Lecture 6</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-python-lectures" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Python Lectures</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-python-lectures">    
        <li>
    <a class="dropdown-item" href="../../Python/Lectures/lecture1.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Python/Lectures/lecture2.html">
 <span class="dropdown-text">Lecture 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Python/Lectures/lecture3.html">
 <span class="dropdown-text">Lecture 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Python/Lectures/lecture4.html">
 <span class="dropdown-text">Lecture 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Python/Lectures/lecture5.html">
 <span class="dropdown-text">Lecture 5</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-julia-assignments" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Julia Assignments</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-julia-assignments">    
        <li>
    <a class="dropdown-item" href="../../Julia/Assignments/Julia_PS_1_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Assignment 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Julia/Assignments/Julia_PS_2_Compecon_Xing_Xu.html">
 <span class="dropdown-text">Assignment 2</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-firm-dynamics" id="toc-what-is-firm-dynamics" class="nav-link active" data-scroll-target="#what-is-firm-dynamics">1 What is firm dynamics?</a></li>
  <li><a href="#whats-specific-about-exporter-dynamics" id="toc-whats-specific-about-exporter-dynamics" class="nav-link" data-scroll-target="#whats-specific-about-exporter-dynamics">2. What’s specific about exporter dynamics?</a></li>
  <li><a href="#firm-level-facts-from-firm-level-data-of-us-and-columbia" id="toc-firm-level-facts-from-firm-level-data-of-us-and-columbia" class="nav-link" data-scroll-target="#firm-level-facts-from-firm-level-data-of-us-and-columbia">3. Firm-level facts (from firm-level data of US and Columbia):</a></li>
  <li><a href="#some-questions-to-think-about" id="toc-some-questions-to-think-about" class="nav-link" data-scroll-target="#some-questions-to-think-about">4. Some questions to think about:</a></li>
  <li><a href="#a-canonical-model-for-exporter-dynamics" id="toc-a-canonical-model-for-exporter-dynamics" class="nav-link" data-scroll-target="#a-canonical-model-for-exporter-dynamics">5. A canonical model for exporter dynamics</a></li>
  <li><a href="#solving-the-model" id="toc-solving-the-model" class="nav-link" data-scroll-target="#solving-the-model">6. Solving the model</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Firm dynamics with an example of exporter dynamics</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="what-is-firm-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="what-is-firm-dynamics">1 What is firm dynamics?</h3>
<p>The firm dynamics literature wants to study firms’ behavior over time. Dynamic models were developed to study firms’ entry and exit decisions, age, size distribution over time and even R&amp; D, export and FDI decisions, etc. More recently, spatial components are incorporated to study, say, firms’ heterogeneous location choices for their subsidiaries.</p>
<p>To dig into the literature, a good starting point is <a href="https://www.jstor.org/stable/2951541">Hopenhayn (1992)</a>, which provides a general theoretical framework that features uncertainty towards future profits, costly market entry and endogenous exit. The literature then expands dramatically with various focuses. Just to list a few, <a href="https://web.stanford.edu/~klenow/Klette%20and%20Kortum.pdf">Klette and Kortum</a> on innovations and firm distribution, <a href="https://www.aeaweb.org/articles?id=10.1257/aer.91.5.1286">Cooley and Quadrini (2001)</a> on financial frictions, <a href="https://www.jstor.org/stable/4502011">Das et al.&nbsp;(2007)</a> on exporter dynamics.</p>
</section>
<section id="whats-specific-about-exporter-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="whats-specific-about-exporter-dynamics">2. What’s specific about exporter dynamics?</h3>
<p>In a world where large multinationals take up a huge chunk of global economy via exports, the roles these giants play is a very interesting research topic. The OECD estimated in 2018 that multinational corporations account for half of global exports, nearly a third of world GDP (28%), and about a fourth of global employment. They hold great market power and sometimes even directly alter domestic and foreign policies. Understanding their growth and policy implications is a fascinating ongoing topic, which requires a lot of the tools discussed here. We can use the dynamic trade framework to study firms’ individual and aggregate behavior, international policies and their implications on consumer welfare.</p>
<p>For the remaining part of this section, I will discuss some empirical evidence about firm-level exporting behavior. I mainly follow from the literature review on <a href="https://www.nber.org/system/files/working_papers/w27934/w27934.pdf">firm dynamics and trade</a> by George, Costas and Kim, ARE 2021.</p>
</section>
<section id="firm-level-facts-from-firm-level-data-of-us-and-columbia" class="level3">
<h3 class="anchored" data-anchor-id="firm-level-facts-from-firm-level-data-of-us-and-columbia">3. Firm-level facts (from firm-level data of US and Columbia):</h3>
<p>Static or time-invariant facts: * There are few exporters. * Exports are a small share of an exporter’s total sales. * Exporters are relatively large firms.</p>
<p>These facts can already trigger our thinking about the underlying firm distribution in size and productivity. These are consistent with the results of <a href="https://www.jstor.org/stable/1555536">Melitz (2003)</a>. Within a group of firms originally producing domestically, only the most productive firms enter the export market. They stay in the market and force the less productive firms to exit.</p>
<p>If we further take a look at the dynamic aspect of the data, there are some more interesting observations:</p>
<ul>
<li>Past export participation is the main predictor of current export participation.</li>
<li>Exporter are less likely to exit if they are older and larger exporters in the past.</li>
<li>Entry rate is increasing in size and past export activity.</li>
<li>The longer an exporter stays in the market, the more it tends to export.</li>
</ul>
<p>These can explain why the dynamic aspect is vital to studying the exporting firms’ behavior. I will show some predictions of the results when we go to the theoretical framework.</p>
<p>There are also evidences about heterogeneity between exporters on their export destinations, shipment volumes and frequencies and inventories.</p>
<p>At last, The long-run response of aggregate trade volumes to changes in trade policy is larger than the short-run response. An important reason, as shown in <a href="https://www.jstor.org/stable/10.1086/670272">Kehoe and Ruhl (2013)</a>, is that the aggregate trade growth is stronger in the long term due to the extensive margin. That is, during a trade liberalization, previously non-traded products grow faster than products that have already been traded between the same country pairs. One take-away is that larger quantities of firms (for concreteness, plants) would become exporters when there are ease in bilateral trade policies. Combining with the fact that exporters take time to grow, this gives a possible explanation for the long-run growth of trade.</p>
</section>
<section id="some-questions-to-think-about" class="level3">
<h3 class="anchored" data-anchor-id="some-questions-to-think-about">4. Some questions to think about:</h3>
<p>On building a model, what structures do we need on individual firm’s problem to retrieve the same results as we observe? For example, how to make sure that only a few firms enter into the export market and coincidentally they are relatively large? What about on the market structure and the demand side?</p>
<p>Next, we can think about idiosyncratic and aggregate uncertainties. Idiosyncratic shock is convenient to generate endogenous entry and exit, as in the firm dynamics literature. Now we can look at if there are any heterogeneous short and long run responses to aggregate uncertainties, say real exchange rate fluctuations. If so, what are the policy implications?</p>
<p>A very important topic in the trade literature is the gains from trade. That is the welfare gain of household in a country facing some sort of trade liberalization. Although the focus of our model is mainly on the firm side, we can still analyze the aggregate impact under a general equilibrium framework.</p>
</section>
<section id="a-canonical-model-for-exporter-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="a-canonical-model-for-exporter-dynamics">5. A canonical model for exporter dynamics</h3>
<p>The model is a slightly tweaked version of <a href="https://www.jstor.org/stable/4502011">Das et al.&nbsp;(2007)</a>, based upon <a href="https://www.jstor.org/stable/1555536">Melitz (2003)</a>. For further reference, <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/iere.12232">Ruhl and Willis (2017)</a> and <a href="http://kjrs3.com/research/acr_trade_adjustment.pdf">Alessandria et al.&nbsp;(2021)</a>.</p>
<p>This section is arranged as follows. I will first lay out the static model and provide analytical solutions to it. Next, I will provide the dynamic setup of the model and compute the model. To look at the firms’ short-term reaction to some sudden and unexpected (MIT) shocks, I will then illustrate the algorithms for obtaining the transition dynamics. In the end, I will provide some basic calibration and some preliminary results. I run some experiments and look at the exporters’ full dynamics facing different shocks.</p>
<section id="static-model" class="level4">
<h4 class="anchored" data-anchor-id="static-model">5.1 Static model</h4>
<section id="consumer" class="level5">
<h5 class="anchored" data-anchor-id="consumer">5.1.1 Consumer</h5>
<p>A representative consumer in domestic economy has preferences over an aggregate consumption good, <span class="math inline">\(C\)</span>. Each index <span class="math inline">\(j\)</span> denotes a differentiated variety. <span class="math inline">\(C\)</span> takes the form: <span class="math display">\[
    C = \left(\sum_{j=1}^{J} c_j^\frac{\theta - 1}{\theta} \right)^\frac{\theta}{\theta - 1},
\]</span> where <span class="math inline">\(\theta\)</span> is the elasticity of substitution between varieties, and J is the number of available varieties. The consumer maximize his utility subject to the budget constraint: <span class="math display">\[
    \sum_{j=1}^{J} c_j p_j = I.
\]</span> The consumer takes prices as given and chooses optimal consumption <span class="math inline">\(c_j\)</span> of each variety: <span class="math display">\[
    c_j = (\frac{p_j}{P})^{-\theta}C,
\]</span> where P is an aggregate price level given by: <span class="math display">\[
    P = \left(\sum_{j=1}^{J} p_j^{1-\theta} \right)^{\frac{1}{1 - \theta}}.
\]</span> The foreign market is identical to the domestic market with demand and consumption satisfying: <span class="math display">\[
    \begin{aligned}
    c_j^* &amp;= (\frac{p_j^*}{P^*})^{-\theta}C^*, \\
    P^* &amp;= \left(\sum_{j=1}^{J} {p_j^*}^{1-\theta} \right)^{\frac{1}{1 - \theta}}. \\
    \end{aligned}
\]</span> Countries have same elasticity <span class="math inline">\(\theta\)</span> for differentiated goods but differ in aggregate level of demands and prices.</p>
</section>
<section id="firms-static-problem" class="level5">
<h5 class="anchored" data-anchor-id="firms-static-problem">5.1.2 Firm’s static problem</h5>
<p>Assume each firm operates solely on a market <span class="math inline">\(j\)</span>, so “plants” will be a better term than “firms”. Plant operates monopolistically in each differentiated variety. Plant chooses the optimal amounts to produce in domestic and foreign market. A unit good produced with plant-level technology $_j $, labor <span class="math inline">\(n_j\)</span> and capital <span class="math inline">\(k_j\)</span> subject to: <span class="math display">\[
    f(\tilde{\epsilon}_j, n_j, k_j) = \tilde{\epsilon}_j  n_j^{\alpha_N}k_j^{\alpha_K},
\]</span> where we assume nonincreasing returns to scale of the production technology, <span class="math inline">\(\alpha_N + \alpha_K &lt;= 1\)</span>.</p>
<p>In each period, the plant chooses the prices, production, inputs, and export status next period <span class="math inline">\(X'\)</span> (<span class="math inline">\(X'=1\)</span> if exporting next period and <span class="math inline">\(X'=0\)</span> if not) to maximize its infinite horizon utility. The plant also faces an iceberg cost <span class="math inline">\(\xi_j\)</span>, where fraction <span class="math inline">\(\xi_j - 1\)</span> of an export shipment is destroyed in transportation. In addition, foreign market might put an ad valorem tariff <span class="math inline">\(\tau_j\)</span> on exports.</p>
<p>We can thus first solve for the plant’s single period or static problem given all the states and plant’s export decision last period. A plant’s profit is sum of revenue from domestic and foreign sales less the input costs: <span class="math display">\[
\Pi_j =  p_j y_j + I(X_j = 1) (1 - \tau_j) Q p_j^* y_j^* - wn_j - rk_j,
\]</span> where <span class="math inline">\(Q\)</span> is the real exchange rate; r is the rental rate of capital; and w is the wage. The plant is also subject to its feasibility constraint: <span class="math display">\[
y_j + \xi_j y_j^* = \tilde{\epsilon}_j  n_j^{\alpha_N}k_j^{\alpha_K}.
\]</span> With market clearing condition in both markets <span class="math inline">\(c_j = y_j\)</span> and <span class="math inline">\(c^*_j = y^*_j\)</span> if <span class="math inline">\(X_j = 1\)</span>, with demand functions from the household problem. The plant charges constant markup over marginal cost in both markets: <span class="math display">\[
    \begin{aligned}
    p_j &amp;= \frac{\theta}{\theta - 1} {MC}_j \\
    Q p_j^* &amp;= \frac{1}{1- \tau_j} \frac{\theta}{\theta - 1} \xi_j {MC}_j.
    \end{aligned}
\]</span> where <span class="math inline">\(MC_j = \frac{1}{\tilde{\epsilon_j}} \left(\frac{w}{\alpha_n}\right)^{\alpha_n} \left(\frac{r}{1 - \alpha_n}\right)^{1 - \alpha_n}\)</span> with <span class="math inline">\(\alpha_n + \alpha_k = 1\)</span> (if not, the formula for marginal cost will be more complicated).</p>
<p>The plant’s static profit maximization problem is: <span class="math display">\[
\Pi_j = \max_{y_j, y_j^*}\{ P C^{\frac{1}{\theta}} y_j^\frac{\theta - 1}{\theta} +  I(X_j = 1) (1 - \tau_j) Q P^* {C^*}^{\frac{1}{\theta}}  {y_j^*}^\frac{\theta - 1}{\theta} - wn_j - rk_j\},
\]</span> subject to equation the feasibility constraint. The optimal amounts for a plant to produce in domestic and foreign markets are: <span class="math display">\[
\begin{aligned}
y_{j} &amp;=\frac{ \xi_j^{\theta} (1 - \tau_j)^{-\theta}   (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}}{I \left(X_{j}=1\right) \xi_j + \xi_j^{\theta} (1 - \tau_j)^{-\theta} (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}} \tilde{\epsilon}_{j} n_{j}^{\alpha_{N}} k_{j}^{\alpha_{K}} \\
y_{j}^{*} &amp;= \frac{I(X_j = 1)}{\xi_j+ \xi_j^{\theta} (1 - \tau_j)^{-\theta} (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}} \tilde{\epsilon}_{j} n_{j}^{\alpha_{N}} k_{j}^{\alpha_{K}} .
\end{aligned}
\]</span></p>
<p>Substituting in <span class="math inline">\(y_j\)</span> and <span class="math inline">\(y_j^*\)</span> to the profit maximization problem yields: <span class="math display">\[
\begin{aligned}
\Pi\left(X_{j}, \xi_j,  \epsilon_{j}, Q\right)=&amp;\max _{n_{j}, k_{j}} M n_{j}^{\alpha_{N} \frac{(\theta-1)}{\theta}} k_{j}^{\alpha_{K} \frac{(\theta-1)}{\theta}} - wn_{j}- r k_{j},
\end{aligned}
\]</span> where <span class="math inline">\(M = \left(1+I\left(X_{j}=1\right) \xi_j^{1 - \theta} (1 - \tau_j)^\theta \left(\frac{Q P^*}{P}\right)^{\theta} \frac{C^{*}}{C}\right)^{\frac{1}{\theta}} P C^{\frac{1}{\theta}} \tilde{\epsilon}_{j}^{\frac{\theta-1}{\theta}}\)</span></p>
<p>From first order conditions of labor and capital, for simplicity write <span class="math inline">\(a = \alpha_{N} \frac{(\theta-1)}{\theta}\)</span> and <span class="math inline">\(b = \alpha_{K} \frac{(\theta-1)}{\theta}\)</span>, the maximized profit can be solved as: <span class="math display">\[
\Pi\left(X_{j}, \xi_j, \epsilon_{j}, Q\right) = M^{\frac{1}{1-a-b}} (1-a-b) (\frac{a}{w})^{\frac{a}{1-a-b}} (\frac{b}{r})^{\frac{b}{1-a-b}}.
\]</span> Equate <span class="math inline">\(\xi_j = 1\)</span> you get exactly the plant’s profit without export iceberg cost. Then with only export fixed cost driving the export barrier, the model is equivalent to the baseline sunk cost model from . Assuming no tariff, using the same notation, the profit a plant earns with an iceberg cost is exactly <span class="math inline">\(\left({\frac{1+I\left(X_{j}=1 \right) \xi_j^{1 - \theta} \left(\frac{Q P^*}{P}\right)^{\theta} \frac{C^{*}}{C}}{1+I\left(X_{j}=1\right) \left(\frac{Q P^*}{P}\right)^{\theta} \frac{C^{*}}{C}}}\right)^\frac{1}{\theta (1- a-b)}\)</span> of the same plant without an iceberg cost.</p>
<p>Just for clarification, we can also solve for domestic and foreign sales: <span class="math display">\[
    \begin{aligned}
       p_j y_{j} &amp;= \left(\frac{ \xi_j^{\theta} (1 - \tau_j)^{-\theta} (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}}{I \left(X_{j}=1\right) \xi_j + \xi_j^{\theta} (1 - \tau_j)^{-\theta} (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}}\right)^{\frac{\theta - 1}{\theta}}   \\
       &amp; \ \ \ \ \ \ \ \ \ \ P C^{\frac{1}{\theta}} \epsilon_j M^{\frac{a + b}{1-a-b}} (\frac{a}{w})^{\frac{a}{1-a-b}} (\frac{b}{r})^{\frac{b}{1-a-b}} \\
       Q p_j^* y_j^* &amp;= I(X_j = 1) \left(\frac{1}{\xi_j+ \xi_j^{\theta} (1 - \tau_j)^{-\theta} (\frac{P}{Q P^*})^\theta \frac{C}{C^{*}}}\right)^{\frac{\theta - 1}{\theta}} \\
       &amp; \ \ \ \ \ \ \ \ \ \  Q P^* {C^*}^{\frac{1}{\theta}} \epsilon_j M^{\frac{a + b}{1-a-b}} (\frac{a}{w})^{\frac{a}{1-a-b}} (\frac{b}{r})^{\frac{b}{1-a-b}} .
    \end{aligned}
\]</span></p>
<p>We normalize the size of domestic aggregate demand <span class="math inline">\(C\)</span> to 1, so <span class="math inline">\(C^*\)</span> denotes the size of foreign demand relative the domestic demand. Define <span class="math inline">\(\epsilon_j = {\tilde{\epsilon}_j}^\frac{\theta - 1}{\theta}\)</span>, which follows an idiosyncratic AR1 shock for each plant. We normalize the mean of the <span class="math inline">\(\epsilon\)</span> process to one.</p>
<p>Firms face idiosyncratic productivity shocks, a fixed cost for becoming an exporter abd and an iceberg cost for exports.</p>
</section>
</section>
<section id="firms-dynamic-problem" class="level4">
<h4 class="anchored" data-anchor-id="firms-dynamic-problem">5.2 Firm’s Dynamic problem</h4>
<p>We first introduce an export fixed cost structure as in <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/iere.12232">Ruhl and Willis (2017)</a>. The plant faces a sunk entry cost <span class="math inline">\(f_E\)</span> and a continuation cost <span class="math inline">\(f_C\)</span>, <span class="math inline">\(f_C \leq f_E\)</span>. All export decisions are made at the end of previous period and fixed costs are paid upon decision. The exporting cost of each period can be expressed as: <span class="math display">\[
    f(X, X') = (1-X) * f_E * X' + X * f_C * X' .
\]</span></p>
<p>We then link the export decision of a plant with an endogenous and stochastic iceberg transportation cost <span class="math inline">\(\xi_j\)</span> as in <a href="http://kjrs3.com/research/acr_trade_adjustment.pdf">Alessandria et al.&nbsp;(2021)</a>. A non-exporting plant doesn’t ship any goods abroad and we set its iceberg cost this period to infinity. The nonexporter can deterministically lower its fixed cost next period to <span class="math inline">\(\xi_E\)</span> by paying <span class="math inline">\(f_E\)</span>. If a current exporter pays <span class="math inline">\(f_C\)</span> to continue exporting next period, it draws iceberg cost <span class="math inline">\(\xi_j \in \{\xi_E, \xi_C\}\)</span> next period stochastically. The structure of the iceberg cost conditional on continuing to exporting can be summarized by a markov chain with states <span class="math inline">\(\xi_E\)</span> and <span class="math inline">\(\xi_C\)</span> with transition probability <span class="math inline">\([ \rho_{EE}, 1- \rho_{EE} ; 1 - \rho_{CC}, \rho_{CC} ]\)</span>. Assume <span class="math inline">\(\xi_C \leq \xi_E &lt; \infty\)</span>. If an exporter stops paying <span class="math inline">\(f_C\)</span>, it exits the export market and becomes a nonexporter with infinite iceberg cost next period.</p>
<p>We also have a persistent condition as <span class="math inline">\(\rho_\xi(\xi_E|\xi_C) \leq \rho_\xi(\xi_C|\xi_E)\)</span>. With a lot of plants, this particular structure of iceberg cost creates incentives for some plants to invest in export technology and make the “better” exporters to become less susceptible to unfavorable shocks.</p>
<p>One last component is the technological shock <span class="math inline">\(\epsilon_j\)</span> that governs plant productivity, which generates heterogeneous plants and varying entry and exit export decisions of plants. It follows an idiosyncratic and time-invariant AR(1) processes for each plant: <span class="math display">\[\begin{equation}
\ln{\epsilon_t} = \rho_\epsilon\ln{\epsilon_{t-1}} + w_{\epsilon,t}, \hspace{1cm} w_\epsilon \sim N(0, \sigma^2_\epsilon).
\end{equation}\]</span> The shocks are discretized using Tauchen’s method. There are three key parameters to determine here: {{<span class="math inline">\(N_\epsilon\)</span>, <span class="math inline">\(\rho_\epsilon\)</span>, <span class="math inline">\(\sigma_\epsilon\)</span>}}. <span class="math inline">\(N_\epsilon\)</span> is the states of plant’s productivity, currently set to 1000 for simplicity.</p>
<p>We put aside our discussion of exchange rate shocks for the moment as an aggregate shock will make solving for the equilibrium prices and transition dynamics much harder. Exchange rates directly shift the export prices and create more uncertainties which make the foreign market more volatile. In particularly “bad” periods, there can be no firms deciding to export, leading to potentially poor simulation results.</p>
<p>In each period, every plant makes an discrete choice based on their current status and discounted expectation of future profits. The discount rate <span class="math inline">\(R\)</span> is set to be <span class="math inline">\(\frac{1}{1+r}\)</span>. We characterize the dynamic problem of each plant by the following Bellman equation: <span class="math display">\[
V\left(X_{j}, \xi_j, \epsilon_{j}, Q\right)=\max _{X_{j}^{\prime}}\left\{\Pi\left(X_{j}, \xi_j, \epsilon_{j}, Q\right)-f\left(X_{j}, X'_{j} \right)+R \underset{\xi_j^{\prime}, \epsilon_{j}^{\prime}, Q^{\prime}}{\mathbb{E}} V\left(X_{j}^{\prime}, \xi_j^{\prime}, \epsilon_{j}^{\prime}, Q^{\prime}\right)\right\}.
\]</span></p>
<p>The policy function for export entry is thus: <span class="math display">\[
    X_{j}^{\prime}\left(0, \infty, \epsilon_{j}, Q\right)= \begin{cases}1 &amp; \text{ if } \hspace{0.5cm}  - f_E + \\
{} &amp; R \underset{\xi_j^{\prime}, \epsilon_{j}^{\prime}, Q^{\prime}}{\mathbb{E}} \left[V\left(1, \xi_E, \epsilon_{j}^{\prime}, Q^{\prime}\right)-V\left(0, \infty, \epsilon_{j}^{\prime}, Q^{\prime}\right)\right] \geq 0 \\ 0 &amp; \text { otherwise. }\end{cases}
\]</span></p>
<p>The inequality on the right is the condition of a non-exporting plant choosing to be an exporter next period. The first two terms denote the current period profit minus the entry fixed cost. The discounted expectation is the difference of expected future values between starting to become an exporter with a low export technology <span class="math inline">\(\xi_E\)</span> and staying as an nonexporter.</p>
</section>
</section>
<section id="solving-the-model" class="level3">
<h3 class="anchored" data-anchor-id="solving-the-model">6. Solving the model</h3>
<p>As always, let’s input some parameter value. I made the simplifying assumption that the real exchange rate <span class="math inline">\(Q\)</span> is fixed.</p>
<div id="cell-9" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>, <span class="bu">Statistics</span>, <span class="bu">Distributions</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Base</span>.<span class="pp">@kwdef</span> <span class="kw">struct</span> Exporter{T1, T2, R1, S}</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    r<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.109</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    αn<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.45</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    αk<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> αn</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    θ<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">5.0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    w<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ξE<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">1.6</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    ξC<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">1.2</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    ξ<span class="op">::</span><span class="dt">T1 </span><span class="op">=</span> [ξE; ξC]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    ρEE<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.92</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    ρCC<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.92</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    Ξ<span class="op">::</span><span class="dt">T2 </span><span class="op">=</span> [ρEE (<span class="fl">1.0</span><span class="op">-</span>ρEE); (<span class="fl">1.0</span><span class="op">-</span>ρCC) ρCC]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    Q<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">1.0</span> <span class="co"># fix exchange rate for the moment</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    fE<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.6</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    fC<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    ρϵ<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.872524</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    σϵ<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.115886</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    Cstar<span class="op">::</span><span class="dt">R1 </span><span class="op">=</span> <span class="fl">0.7</span> <span class="co">#C normalized to be 1.0</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    grids<span class="op">::</span><span class="dt">S </span><span class="op">=</span> <span class="fl">100</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> (<span class="fl">1</span><span class="op">/</span>(<span class="fl">1</span><span class="op">+</span>r))<span class="op">^</span><span class="fl">0.25</span> <span class="co"># quarterly discount factor</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>E <span class="op">=</span> <span class="fu">Exporter</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Exporter{Vector{Float64}, Matrix{Float64}, Float64, Int64}(0.109, 0.45, 0.55, 5.0, 0.02, 1.6, 1.2, [1.6, 1.2], 0.92, 0.92, [0.92 0.07999999999999996; 0.07999999999999996 0.92], 1.0, 0.6, 0.2, 0.872524, 0.115886, 0.7, 100, 0.9744669483879411)</code></pre>
</div>
</div>
<section id="discretize-an-ar1-process" class="level4">
<h4 class="anchored" data-anchor-id="discretize-an-ar1-process">6.1 Discretize an AR(1) process</h4>
<p>Recall that the reason we use discrete approximations of value functions is that the computer can’t process continuos variables. Same logic applies with an AR(1) process. We want to approximate the AR(1) process with a discrete markov chain, which is characterized by discrete states and a transition probability matrix. Check <a href="https://julia.quantecon.org/introduction_dynamics/finite_markov.html">Quantecon’s lecture notes</a> for a detailed explanation.</p>
<p>Again the AR(1) process we want to discretize is: <span class="math display">\[
\ln{\epsilon_t} = \rho_\epsilon\ln{\epsilon_{t-1}} + w_{\epsilon,t}, \hspace{1cm} w_\epsilon \sim N(0, \sigma^2_\epsilon).
\]</span></p>
<p>The code (adopted from Quantecon) is:</p>
<div id="cell-14" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">tauchen</span>(N<span class="op">::</span><span class="dt">Integer</span>, ρ<span class="op">::</span><span class="dt">T1</span>, σ<span class="op">::</span><span class="dt">T2</span>, μ<span class="op">=</span><span class="fu">zero</span>(<span class="fu">promote_type</span>(T1, T2)), n_std<span class="op">::</span><span class="dt">T3</span>=<span class="fl">3</span>) <span class="kw">where</span> {T1 <span class="op">&lt;:</span><span class="dt"> Real</span>, T2 <span class="op">&lt;:</span><span class="dt"> Real</span>, T3 <span class="op">&lt;:</span><span class="dt"> Real</span>}</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get discretized space</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  a_bar <span class="op">=</span> n_std <span class="op">*</span> <span class="fu">sqrt</span>(σ<span class="op">^</span><span class="fl">2</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> ρ<span class="op">^</span><span class="fl">2</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  y <span class="op">=</span> <span class="fu">range</span>(<span class="op">-</span>a_bar, stop<span class="op">=</span>a_bar, length<span class="op">=</span>N)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  d <span class="op">=</span> y[<span class="fl">2</span>] <span class="op">-</span> y[<span class="fl">1</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get transition probabilities</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  Π <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">promote_type</span>(T1, T2), N, N)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> row <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>N</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Do end points first</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      Π[row, <span class="fl">1</span>] <span class="op">=</span> <span class="fu">cdf</span>(<span class="fu">Normal</span>(),(y[<span class="fl">1</span>] <span class="op">-</span> ρ<span class="op">*</span>y[row] <span class="op">+</span> d<span class="op">/</span><span class="fl">2</span>) <span class="op">/</span> σ)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      Π[row, N] <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="fu">cdf</span>(<span class="fu">Normal</span>(),(y[N] <span class="op">-</span> ρ<span class="op">*</span>y[row] <span class="op">-</span> d<span class="op">/</span><span class="fl">2</span>) <span class="op">/</span> σ)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># fill in the middle columns</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> col <span class="op">=</span> <span class="fl">2</span><span class="op">:</span>N<span class="op">-</span><span class="fl">1</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>          Π[row, col] <span class="op">=</span> (<span class="fu">cdf</span>(<span class="fu">Normal</span>(),(y[col] <span class="op">-</span> ρ<span class="op">*</span>y[row] <span class="op">+</span> d<span class="op">/</span><span class="fl">2</span>) <span class="op">/</span> σ) <span class="op">-</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">cdf</span>(<span class="fu">Normal</span>(),(y[col] <span class="op">-</span> ρ<span class="op">*</span>y[row] <span class="op">-</span> d<span class="op">/</span><span class="fl">2</span>) <span class="op">/</span> σ))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  yy <span class="op">=</span> <span class="fu">exp</span>.(y <span class="op">.+</span> μ <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> ρ)) <span class="co"># center process around its mean (wbar / (1 - rho)) in new variable</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># take exponential to get to a ln process</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># renormalize. In some test cases the rows sum to something that is 2e-15</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># away from 1.0, which caused problems in the MarkovChain constructor</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  Π <span class="op">=</span> Π<span class="op">./</span><span class="fu">sum</span>(Π, dims <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Π, yy</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tauchen (generic function with 3 methods)</code></pre>
</div>
</div>
<div id="cell-15" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Π, ϵ_vec <span class="op">=</span> <span class="fu">tauchen</span>(<span class="fl">100</span>, E.ρϵ, E.σϵ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>([0.2355397082043846 0.0398220365205688 … 0.0 0.0; 0.2035639923092491 0.03686888293414207 … 0.0 0.0; … ; 4.784202347164862e-30 1.4778853656337744e-29 … 0.03686888293414202 0.20356399230924901; 1.3827115757372961e-30 4.347177100735715e-30 … 0.039822036520568704 0.23553970820438463], [0.4908675431085489, 0.4979749102029403, 0.5051851862545925, 0.5124998613024105, 0.5199204469598645, 0.5274484767273707, 0.5350855063091983, 0.5428331139349621, 0.5506929006857724, 0.5586664908251056  …  1.7899766970506505, 1.8158941194896647, 1.84218680535361, 1.8688601881549594, 1.8959197800790755, 1.9233711731233287, 1.9512200402527142, 1.9794721365721941, 2.0081333005160213, 2.0372094550542794])</code></pre>
</div>
</div>
</section>
<section id="functions" class="level4">
<h4 class="anchored" data-anchor-id="functions">6.2 Functions</h4>
<p>Exporter fixed cost (just for illustration, we don’t use this function)</p>
<div id="cell-18" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">expfixcost</span>(X1<span class="op">::</span><span class="dt">Int</span>, X2<span class="op">::</span><span class="dt">Int</span>; E <span class="op">=</span> E)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#X1 and X2 are 0, 1 variables</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    f <span class="op">=</span> (<span class="fl">1</span><span class="op">-</span>X1) <span class="op">*</span> E.fE <span class="op">*</span> X2 <span class="op">+</span> X1 <span class="op">*</span> E.fC <span class="op">*</span> X2;</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>expfixcost (generic function with 1 method)</code></pre>
</div>
</div>
<p>Firm’s profit function</p>
<div id="cell-20" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">profit</span>(X, Evalue, ξ_idx, P, Pstar; E<span class="op">=</span> E, Qvalue <span class="op">=</span> E.Q, τ <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    (;θ, Cstar, αn, αk, w, r, ξ ) <span class="op">=</span> E</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> X <span class="op">*</span> ξ[ξ_idx]<span class="op">^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ)<span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> τ)<span class="op">^</span>θ <span class="op">*</span> ((Qvalue <span class="op">*</span> Pstar<span class="op">/</span> P)<span class="op">^</span>θ) <span class="op">*</span> Cstar)<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>θ) <span class="op">*</span> P <span class="op">*</span> Evalue</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> αn <span class="op">*</span> (θ <span class="op">-</span> <span class="fl">1.0</span>)<span class="op">/</span>θ</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> αk <span class="op">*</span> (θ <span class="op">-</span> <span class="fl">1.0</span>)<span class="op">/</span>θ</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    Profit <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b) <span class="op">*</span> M<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (a<span class="op">/</span>w)<span class="op">^</span>(a<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (b<span class="op">/</span>r)<span class="op">^</span>(b<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Profit</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>profit (generic function with 1 method)</code></pre>
</div>
</div>
<p>Sales at domestic and foreign markets:</p>
<div id="cell-22" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sales</span>(X, Evalue, ξ_idx, P, Pstar; E<span class="op">=</span> E, Qvalue <span class="op">=</span> E.Q, τ <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    (;θ, Cstar, αn, αk, w, r, ξ) <span class="op">=</span> E</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> (<span class="fl">1.0</span> <span class="op">+</span> X <span class="op">*</span> ξ[ξ_idx]<span class="op">^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ)<span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> τ)<span class="op">^</span>θ <span class="op">*</span> ((Qvalue <span class="op">*</span> Pstar<span class="op">/</span> P)<span class="op">^</span>θ) <span class="op">*</span> Cstar)<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>θ) <span class="op">*</span> P <span class="op">*</span> Evalue</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> αn <span class="op">*</span> (θ <span class="op">-</span> <span class="fl">1.0</span>)<span class="op">/</span>θ</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> αk <span class="op">*</span> (θ <span class="op">-</span> <span class="fl">1.0</span>)<span class="op">/</span>θ</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> ξ[ξ_idx]<span class="op">^</span>θ <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> τ)<span class="op">^</span>(<span class="op">-</span>θ) <span class="op">*</span> (P<span class="op">/</span> (Qvalue <span class="op">*</span> Pstar))<span class="op">^</span>θ<span class="op">/</span>Cstar</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    sales_do <span class="op">=</span> (con<span class="op">/</span>(X <span class="op">*</span> ξ[ξ_idx] <span class="op">+</span> con))<span class="op">^</span>((θ<span class="op">-</span><span class="fl">1.0</span>)<span class="op">/</span>θ) <span class="op">*</span> P <span class="op">*</span> Evalue <span class="op">*</span> M<span class="op">^</span>((a <span class="op">+</span> b)<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (a<span class="op">/</span>w)<span class="op">^</span>(a<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (b<span class="op">/</span>r)<span class="op">^</span>(b<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        sales_fo <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        sales_fo <span class="op">=</span> (<span class="fl">1.0</span><span class="op">-</span>τ) <span class="op">*</span> (<span class="fl">1.0</span><span class="op">/</span>(ξ[ξ_idx] <span class="op">+</span> con))<span class="op">^</span>((θ<span class="op">-</span><span class="fl">1.0</span>)<span class="op">/</span>θ) <span class="op">*</span> Qvalue <span class="op">*</span> Pstar <span class="op">*</span> Cstar<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>θ) <span class="op">*</span> Evalue <span class="op">*</span> M<span class="op">^</span>((a <span class="op">+</span> b)<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (a<span class="op">/</span>w)<span class="op">^</span>(a<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="op">*</span> (b<span class="op">/</span>r)<span class="op">^</span>(b<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>a<span class="op">-</span>b)) <span class="co"># foreign sales net of tariffs</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [sales_do, sales_fo]</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>sales (generic function with 1 method)</code></pre>
</div>
</div>
<p>Take a try on the functions. Again <code>.</code> is used for broadcasting and <code>Ref()</code> is used to fix inputs.</p>
<div id="cell-24" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">profit</span>.([<span class="fl">1</span>, <span class="fl">0</span>], [<span class="fl">1.2</span>, <span class="fl">0.8</span>], [<span class="fl">1</span>, <span class="fl">1</span>], <span class="fu">Ref</span>(<span class="fl">0.1</span>), <span class="fu">Ref</span>(<span class="fl">0.2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2-element Vector{Float64}:
 0.08608093339518139
 0.002565830909582643</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">reduce</span>(hcat, <span class="fu">sales</span>.([<span class="fl">1</span>, <span class="fl">0</span>], [<span class="fl">1.2</span>, <span class="fl">0.8</span>], [<span class="fl">1</span>, <span class="fl">1</span>], <span class="fu">Ref</span>(<span class="fl">1.0</span>), <span class="fu">Ref</span>(<span class="fl">1</span>)))<span class="ch">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2×2 adjoint(::Matrix{Float64}) with eltype Float64:
 9742.14  1040.57
 1282.92     0.0</code></pre>
</div>
</div>
<p>Individual prices (<span class="math inline">\(p_j\)</span> and <span class="math inline">\(p_j^*\)</span>)</p>
<p>The function defined here needs to be modified to incorporate cases where <span class="math inline">\(\alpha_n + \alpha_k \neq 1\)</span>.</p>
<div id="cell-27" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ind_price</span>(X, Evalue, ξ_idx; E <span class="op">=</span> E, Qvalue <span class="op">=</span> E.Q, τ <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    (;θ, αn, αk, w, r, ξ) <span class="op">=</span> E</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    MC <span class="op">=</span> Evalue<span class="op">^</span>(θ<span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ)) <span class="op">*</span> (w<span class="op">/</span>αn)<span class="op">^</span>αn <span class="op">*</span> (r<span class="op">/</span>αk)<span class="op">^</span>αk</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    do_p <span class="op">=</span> (θ<span class="op">/</span>(θ <span class="op">-</span> <span class="fl">1.0</span>)) <span class="op">*</span> MC</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X <span class="op">==</span> <span class="fl">0</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        fo_p <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span> <span class="co"># make foreign price negative for non-exporters</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        fo_p <span class="op">=</span> (θ<span class="op">/</span>(θ <span class="op">-</span> <span class="fl">1.0</span>)) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">-</span> τ) <span class="op">*</span> ξ[ξ_idx] <span class="op">*</span> MC<span class="op">/</span>Qvalue</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [do_p, fo_p]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ind_price (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ind_p_mat <span class="op">=</span> <span class="fu">reduce</span>(hcat, <span class="fu">ind_price</span>.([<span class="fl">0</span> <span class="fl">1</span>], [<span class="fl">1.0</span> <span class="fl">1.2</span>], [<span class="fl">1</span> <span class="fl">1</span>]))<span class="ch">'[:,1]</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ind_pstar_mat <span class="op">=</span> <span class="fu">reduce</span>(hcat, <span class="fu">ind_price</span>.([<span class="fl">0</span> <span class="fl">1</span>], [<span class="fl">1.0</span> <span class="fl">1.2</span>], [<span class="fl">1</span> <span class="fl">1</span>]))<span class="ch">'[:,2]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2-element Vector{Float64}:
 -1.0
  0.16104839447304678</code></pre>
</div>
</div>
<p>Aggregate price <span class="math inline">\(P\)</span> and <span class="math inline">\(P^*\)</span></p>
<div id="cell-30" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">agg_price</span>(ind_p_mat, ind_pstar_mat; θ <span class="op">=</span> E.θ)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> (<span class="fu">sum</span>(ind_p_mat<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ)))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    Pstar <span class="op">=</span> ((<span class="fu">sum</span>(ind_pstar_mat[ind_pstar_mat <span class="op">.&gt;=</span> <span class="fl">0</span>])<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ)))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> P, Pstar</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>agg_price (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">agg_price</span>(ind_p_mat, ind_pstar_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.09250365544979017, 0.16104839447304678)</code></pre>
</div>
</div>
</section>
<section id="solve-the-firms-problem" class="level4">
<h4 class="anchored" data-anchor-id="solve-the-firms-problem">6.3 Solve the firm’s problem</h4>
<p>Solving the model is rather standard except that I chose to separate out the problem of a non-exporter and an exporter with either exporting technology <span class="math inline">\(\xi\)</span>.</p>
<div id="cell-34" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_exporter_fixQ</span>(E, P, Pstar, τ; vNX0 <span class="op">=</span> <span class="fu">zeros</span>(E.grids, <span class="fl">1</span>), vEX0 <span class="op">=</span> <span class="fu">zeros</span>(E.grids, <span class="fu">length</span>(E.ξ)), tol <span class="op">=</span> <span class="fl">1e-6</span>, Q <span class="op">=</span> E.Q)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unpacking</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    (; R, fE, fC, ξ, Ξ, fE, fC, ρϵ, σϵ, grids) <span class="op">=</span> E</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    vNX1 <span class="op">=</span> <span class="fu">similar</span>(vNX0) <span class="co"># to store value of non-exporters</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    vEX1 <span class="op">=</span> <span class="fu">similar</span>(vEX0) <span class="co"># to store value of exporters</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    polNX <span class="op">=</span> <span class="fu">similar</span>(vNX0, <span class="dt">Int</span>) <span class="co"># to store policy of non-exporters</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    polEX <span class="op">=</span> <span class="fu">similar</span>(vEX0, <span class="dt">Int</span>) <span class="co"># to store policy of exporters</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    REvNX <span class="op">=</span> <span class="fu">similar</span>(vNX0) <span class="co"># expected value if choosing not to export</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    REvEX_NX <span class="op">=</span> <span class="fu">similar</span>(vNX0) <span class="co"># expected value if choosing to export as a non-exporter</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    REvEX_EX <span class="op">=</span> <span class="fu">similar</span>(vEX0) <span class="co"># expected value if choosing to export as an exporter with different ξ's</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    domesticm, <span class="op">~</span> <span class="op">=</span> <span class="fu">sales</span>(<span class="fl">0</span>, <span class="fl">1.0</span>, <span class="fl">1</span>, P, Pstar; E <span class="op">=</span> E, Qvalue <span class="op">=</span> Q, τ <span class="op">=</span> <span class="fl">0.0</span>) <span class="co"># sales of a non-exporting medium firm</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># productivity process</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    Π, ϵ_vec <span class="op">=</span> <span class="fu">tauchen</span>(grids, ρϵ, σϵ)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Precompute the profits for firms at all states </span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    proNX <span class="op">=</span> <span class="fu">profit</span>.(<span class="fu">zeros</span>(<span class="dt">Int</span>, grids, <span class="fl">1</span>), ϵ_vec, <span class="fu">ones</span>(<span class="dt">Int</span>, grids, <span class="fl">1</span>), <span class="fu">Ref</span>(P), <span class="fu">Ref</span>(Pstar); E<span class="op">=</span> E, Qvalue <span class="op">=</span> Q, τ <span class="op">=</span> τ)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># input for ξ doesn't matter</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    proEX <span class="op">=</span> <span class="fu">similar</span>(vEX0)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(ξ)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        proEX[<span class="op">:</span>,i] <span class="op">=</span> <span class="fu">profit</span>.(<span class="fu">ones</span>(<span class="dt">Int</span>, grids, <span class="fl">1</span>), ϵ_vec, i<span class="op">.*</span><span class="fu">ones</span>(<span class="dt">Int</span>, grids, <span class="fl">1</span>), <span class="fu">Ref</span>(P), <span class="fu">Ref</span>(Pstar); E<span class="op">=</span> E, Qvalue <span class="op">=</span> Q, τ <span class="op">=</span> τ)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VFI</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    iter <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="cn">true</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(vNX0))</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        iter <span class="op">+=</span> <span class="fl">1</span> </span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Precompute RE[V(.)|X, ϵ, ξ] for better performance</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        REvNX <span class="op">=</span> R <span class="op">*</span> Π <span class="op">*</span> vNX0</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        REvEX_NX <span class="op">=</span> R <span class="op">*</span> Π <span class="op">*</span> vEX0[<span class="op">:</span>,<span class="fl">1</span>] <span class="co"># enters with entry export technology</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        REvEX_EX <span class="op">=</span> R <span class="op">*</span> Π <span class="op">*</span> vEX0 <span class="op">*</span> Ξ<span class="ch">'</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        vNX1 <span class="op">=</span> <span class="fu">max</span>.((proNX <span class="op">+</span> REvNX), (proNX <span class="op">.-</span> fE <span class="op">*</span> domesticm <span class="op">+</span> REvEX_NX))</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        vEX1 <span class="op">=</span> <span class="fu">max</span>.((proEX <span class="op">.+</span> REvNX), (proEX <span class="op">.-</span> fC <span class="op">*</span> domesticm <span class="op">+</span> REvEX_EX))</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> <span class="fu">max</span>(<span class="fu">maximum</span>(<span class="fu">abs</span>.(vNX1 <span class="op">-</span> vNX0)), <span class="fu">maximum</span>(<span class="fu">abs</span>.(vEX1 <span class="op">-</span> vEX0)))</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>        (distance <span class="op">&lt;</span> tol <span class="op">||</span> iter <span class="op">==</span> <span class="fl">2000</span>) <span class="op">&amp;&amp;</span> <span class="cf">break</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        vNX0 <span class="op">.=</span> vNX1</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>        vEX0 <span class="op">.=</span> vEX1</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get policy</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    polNX <span class="op">.=</span> <span class="fl">0</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    polEX <span class="op">.=</span> <span class="fl">0</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (REvNX[i]) <span class="op">&lt;</span> (<span class="op">-</span> fE <span class="op">*</span> domesticm <span class="op">+</span> REvEX_NX[i])</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>            polNX[i] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(ξ)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (REvNX[i]) <span class="op">&lt;</span> (<span class="op">-</span> fC <span class="op">*</span> domesticm <span class="op">+</span> REvEX_EX[i,j])</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>                polEX[i,j] <span class="op">=</span> <span class="fl">1</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (vNX <span class="op">=</span> vNX1, vEX <span class="op">=</span> vEX1, polNX <span class="op">=</span> polNX, polEX <span class="op">=</span> polEX, Π <span class="op">=</span> Π, ϵ_vec <span class="op">=</span>ϵ_vec, iter <span class="op">=</span> iter)</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>solve_exporter_fixQ (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="cf">begin</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    sol_try <span class="op">=</span> <span class="fu">solve_exporter_fixQ</span>(E, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.0</span>);</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.021312 seconds (14.35 k allocations: 7.747 MiB, 48.11% gc time)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(vNX = [0.4360154494851622; 0.437186123813252; … ; 1.4838358575240558; 1.5257584977020988;;], vEX = [0.43603928462977926 0.4360907803125939; 0.43721173522491963 0.43726706852173247; … ; 1.5350851689447875 1.680995332627831; 1.5793313776889149 1.7326647962605208], polNX = [0; 0; … ; 1; 1;;], polEX = [0 0; 0 0; … ; 1 1; 1 1], Π = [0.2355397082043846 0.0398220365205688 … 0.0 0.0; 0.2035639923092491 0.03686888293414207 … 0.0 0.0; … ; 4.784202347164862e-30 1.4778853656337744e-29 … 0.03686888293414202 0.20356399230924901; 1.3827115757372961e-30 4.347177100735715e-30 … 0.039822036520568704 0.23553970820438463], ϵ_vec = [0.4908675431085489, 0.4979749102029403, 0.5051851862545925, 0.5124998613024105, 0.5199204469598645, 0.5274484767273707, 0.5350855063091983, 0.5428331139349621, 0.5506929006857724, 0.5586664908251056  …  1.7899766970506505, 1.8158941194896647, 1.84218680535361, 1.8688601881549594, 1.8959197800790755, 1.9233711731233287, 1.9512200402527142, 1.9794721365721941, 2.0081333005160213, 2.0372094550542794], iter = 375)</code></pre>
</div>
</div>
<p>Find the cutoff productivity levels</p>
<div id="cell-37" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">find_cutoff_prod</span>(sol)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    (; polNX, polEX, ϵ_vec) <span class="op">=</span> sol</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    cutoff_ϵ <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">eltype</span>(ϵ_vec), <span class="fu">size</span>(polEX)[<span class="fl">2</span>] <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(polNX)[<span class="fl">1</span>]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> polNX[i] <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>            cutoff_ϵ[<span class="fl">1</span>] <span class="op">=</span> ϵ_vec[i]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(polEX)[<span class="fl">2</span>]</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(polEX)[<span class="fl">1</span>]</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> polEX[i, j] <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>                cutoff_ϵ[j <span class="op">+</span> <span class="fl">1</span>] <span class="op">=</span> ϵ_vec[i]</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span> <span class="co"># only break out of the inner loop</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cutoff_ϵ</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>find_cutoff_prod (generic function with 1 method)</code></pre>
</div>
</div>
<p>Now we can find out the cutoff levels for the productivity <span class="math inline">\(\epsilon\)</span> for different export status <span class="math inline">\(X\)</span> and export technology <span class="math inline">\(\xi\)</span> .</p>
<div id="cell-39" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find_cutoff_prod</span>(sol_try)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3-element Vector{Float64}:
 1.7644291820741218
 1.3818813801525107
 1.1299695318784664</code></pre>
</div>
</div>
<p>This says that among different states, non-exporter needs the highest draw of productivity to become an exporter and the exporter with highest <span class="math inline">\(\xi\)</span> will not go back to a non-exporter only if the productivity falls very low.</p>
</section>
<section id="stationary-distribution-for-firms-given-prices" class="level4">
<h4 class="anchored" data-anchor-id="stationary-distribution-for-firms-given-prices">6.4 Stationary distribution for firms given prices</h4>
<div id="cell-42" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_stationary_distribution</span>(sol;E <span class="op">=</span> E, tol <span class="op">=</span> <span class="fl">1e-8</span>, pdf_0 <span class="op">=</span> <span class="fu">fill</span>(<span class="fl">1.0</span> <span class="op">/</span> (<span class="fu">size</span>(sol_try.vEX)[<span class="fl">1</span>] <span class="op">*</span> (<span class="fu">size</span>(sol_try.vEX)[<span class="fl">2</span>] <span class="op">+</span> <span class="fl">1</span>))  , (<span class="fu">size</span>(sol_try.vEX)[<span class="fl">1</span>] , (<span class="fu">size</span>(sol_try.vEX)[<span class="fl">2</span>] <span class="op">+</span> <span class="fl">1</span>))))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    (; polEX, polNX, vEX, vNX) <span class="op">=</span> sol</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    (; Ξ, ρϵ, σϵ, grids) <span class="op">=</span> E</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># productivity process</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    Π, ϵ_vec <span class="op">=</span> <span class="fu">tauchen</span>(grids, ρϵ, σϵ)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    pdf_1 <span class="op">=</span> <span class="fu">similar</span>(pdf_0)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    iter <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="cn">true</span> </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fill!</span>(pdf_1, <span class="fu">zero</span>(<span class="fu">eltype</span>(pdf_0)))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        iter <span class="op">+=</span><span class="fl">1</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> iprime <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>                pdf_1[iprime,<span class="fl">1</span>] <span class="op">+=</span> (<span class="fl">1</span> <span class="op">-</span> polNX[i]) <span class="op">*</span> pdf_0[i, <span class="fl">1</span>] <span class="op">*</span> Π[i, iprime]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>                pdf_1[iprime,<span class="fl">2</span>] <span class="op">+=</span> polNX[i] <span class="op">*</span> pdf_0[i, <span class="fl">1</span>] <span class="op">*</span> Π[i, iprime]</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(Ξ)[<span class="fl">1</span>]</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>                    pdf_1[iprime,<span class="fl">1</span>] <span class="op">+=</span> (<span class="fl">1</span> <span class="op">-</span> polEX[i,j]) <span class="op">*</span> pdf_0[i, j <span class="op">+</span> <span class="fl">1</span>] <span class="op">*</span> Π[i, iprime]</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> jprime <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(Ξ)[<span class="fl">1</span>]</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>                        pdf_1[iprime,jprime <span class="op">+</span> <span class="fl">1</span>] <span class="op">+=</span> polEX[i, j] <span class="op">*</span> Ξ[j, jprime] <span class="op">*</span> Π[i, iprime] <span class="op">*</span> pdf_0[i ,j <span class="op">+</span> <span class="fl">1</span>] </span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">end</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(pdf_0))</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (a, b) <span class="kw">in</span> <span class="fu">zip</span>(pdf_0, pdf_1)</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>            distance <span class="op">=</span> <span class="fu">max</span>(<span class="fu">abs</span>(a <span class="op">-</span> b), distance)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>        (distance <span class="op">&lt;</span> tol <span class="op">||</span> iter <span class="op">==</span> <span class="fl">2000</span>) <span class="op">&amp;&amp;</span> <span class="cf">break</span> </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>        pdf_0 <span class="op">.=</span> pdf_1</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    pdf_1 <span class="op">=</span> pdf_1</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pdf_1, iter</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>compute_stationary_distribution (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="cf">begin</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    pdf_stationary, <span class="op">~</span> <span class="op">=</span> <span class="fu">compute_stationary_distribution</span>(sol_try)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.072110 seconds (224.32 k allocations: 12.099 MiB, 92.28% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>([0.0011570437242512165 2.1145547603126288e-17 2.4311023610085744e-16; 0.0002998008153782488 3.0370638439024366e-17 3.491402314311281e-16; … ; 8.081413651159851e-5 0.00018671373465131073 3.2272944215721654e-5; 0.00020250322875128642 0.0008151092583492217 0.00013943123715096507], 55)</code></pre>
</div>
</div>
<p>Check if it is still a distribution:</p>
<div id="cell-45" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(pdf_stationary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
</div>
<p>Look at the shares of exporters at each states.</p>
<div id="cell-47" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>NX_share, EX_low_share, EX_high_share <span class="op">=</span> <span class="fu">sum</span>(pdf_stationary, dims <span class="op">=</span> <span class="fl">1</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"The share of nonexporters is </span><span class="sc">$</span>NX_share<span class="st">, the share of exporters with low technology is </span><span class="sc">$</span>EX_low_share<span class="st">, the share of exporters with high technology is </span><span class="sc">$</span>EX_high_share<span class="st">, given prices in the stationary distribution, "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The share of nonexporters is 0.9768202808538854, the share of exporters with low technology is 0.016599699825925476, the share of exporters with high technology is 0.006580019320189167, given prices in the stationary distribution, </code></pre>
</div>
</div>
</section>
<section id="stationary-prices" class="level4">
<h4 class="anchored" data-anchor-id="stationary-prices">6.5 Stationary prices</h4>
<p>Now we have all the pieces ready for the stationary prices.</p>
<p>The algorithm goes as follows:</p>
<ul>
<li>Fix the number of firms N</li>
<li>Start from guesses of <span class="math inline">\(P_0\)</span> and <span class="math inline">\(P^*_0\)</span></li>
<li>For each <span class="math inline">\(P_t\)</span> and <span class="math inline">\(P^*_t\)</span> solve the firm’s problem given prices.</li>
<li>Compute invariant distribution <span class="math inline">\(\lambda(X, \epsilon, \xi)\)</span></li>
<li>Get new individual firm prices according to first order conditions of firms.</li>
<li>Get the updated aggregate prices <span class="math inline">\(P'_t\)</span> and <span class="math inline">\(P'^{*}_t\)</span>.</li>
<li>Guess <span class="math inline">\(P_{t + 1} = ϵ P'_t + (1 - ϵ) P_t\)</span> and <span class="math inline">\(P^*_{t + 1} = ϵ P'^*_t + (1 - ϵ) P^*_t\)</span>. Go back to the second step and iterate until convergence.</li>
</ul>
<div id="cell-49" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">compute_stationary_equilibrium</span>(E; P0<span class="op">=</span><span class="fl">0.1</span>, Pstar0<span class="op">=</span><span class="fl">0.1</span>, tol<span class="op">=</span><span class="fl">1e-5</span>, ϵ<span class="op">=</span><span class="fl">0.2</span>, τ<span class="op">=</span><span class="fl">0.0</span>, N<span class="op">=</span><span class="fl">2000</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    (; Ξ, ρϵ, σϵ, grids, θ) <span class="op">=</span> E</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    Π, ϵ_vec <span class="op">=</span> <span class="fu">tauchen</span>(grids, ρϵ, σϵ)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    ind_p_mat <span class="op">=</span> <span class="fu">zeros</span>(grids, <span class="fu">size</span>(Ξ)[<span class="fl">1</span>] <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    ind_pstar_mat <span class="op">=</span> <span class="fu">zeros</span>(grids, <span class="fu">size</span>(Ξ)[<span class="fl">1</span>] <span class="op">+</span> <span class="fl">1</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> <span class="fu">solve_exporter_fixQ</span>(E, P0, Pstar0, τ)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    pdf, <span class="op">~</span> <span class="op">=</span> <span class="fu">compute_stationary_distribution</span>(sol)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        ind_p_mat[i, <span class="fl">1</span>], ind_pstar_mat[i, <span class="fl">1</span>] <span class="op">=</span> <span class="fu">ind_price</span>(<span class="fl">0</span>, ϵ_vec[i], <span class="fl">1</span>; τ<span class="op">=</span>τ) <span class="op">.*</span> pdf[i, <span class="fl">1</span>]</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(Ξ)[<span class="fl">1</span>]</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            ind_p_mat[i, j<span class="op">+</span><span class="fl">1</span>], ind_pstar_mat[i, j<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="fu">ind_price</span>(<span class="fl">1</span>, ϵ_vec[i], j; τ<span class="op">=</span>τ) <span class="op">.*</span> pdf[i, j<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    Pprime1 <span class="op">=</span> (<span class="fu">sum</span>(ind_p_mat<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ) <span class="op">.*</span>pdf <span class="op">.*</span> N ))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> ind_pstar_mat<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ) <span class="op">.*</span>pdf <span class="op">.*</span> N </span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    Pstarprime1 <span class="op">=</span> (<span class="fu">sum</span>(temp[temp <span class="op">.&gt;</span> <span class="fl">0.0</span>]))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    P1 <span class="op">=</span> ϵ <span class="op">*</span> Pprime1 <span class="op">+</span> (<span class="fl">1.0</span> <span class="op">-</span> ϵ) <span class="op">*</span> P0</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    Pstar1 <span class="op">=</span> ϵ <span class="op">*</span> Pstarprime1 <span class="op">+</span> (<span class="fl">1.0</span> <span class="op">-</span> ϵ) <span class="op">*</span> Pstar0</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    P0 <span class="op">=</span> <span class="fu">copy</span>(P1)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    Pstar0 <span class="op">=</span> <span class="fu">copy</span>(Pstar1)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    iter <span class="op">=</span> <span class="fl">0</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="cn">true</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(P0))</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>        iter <span class="op">+=</span> <span class="fl">1</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>        sol <span class="op">=</span> <span class="fu">solve_exporter_fixQ</span>(E, P0, Pstar0, τ)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>        pdf, <span class="op">~</span> <span class="op">=</span> <span class="fu">compute_stationary_distribution</span>(sol)</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>            ind_p_mat[i, <span class="fl">1</span>], ind_pstar_mat[i, <span class="fl">1</span>] <span class="op">=</span> <span class="fu">ind_price</span>(<span class="fl">0</span>, ϵ_vec[i], <span class="fl">1</span>; τ<span class="op">=</span>τ)</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">size</span>(Ξ)[<span class="fl">1</span>]</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>                ind_p_mat[i, j<span class="op">+</span><span class="fl">1</span>], ind_pstar_mat[i, j<span class="op">+</span><span class="fl">1</span>] <span class="op">=</span> <span class="fu">ind_price</span>(<span class="fl">1</span>, ϵ_vec[i], j; τ<span class="op">=</span>τ)</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>        Pprime1 <span class="op">=</span> (<span class="fu">sum</span>(ind_p_mat<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ) <span class="op">.*</span>pdf <span class="op">.*</span> N ))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>        temp <span class="op">=</span> ind_pstar_mat<span class="op">.^</span>(<span class="fl">1.0</span> <span class="op">-</span> θ) <span class="op">.*</span>pdf <span class="op">.*</span> N </span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>        Pstarprime1 <span class="op">=</span> (<span class="fu">sum</span>(temp[temp <span class="op">.&gt;</span> <span class="fl">0.0</span>]))<span class="op">^</span>(<span class="fl">1.0</span><span class="op">/</span>(<span class="fl">1.0</span> <span class="op">-</span> θ))</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>        P1 <span class="op">=</span> ϵ <span class="op">*</span> Pprime1 <span class="op">+</span> (<span class="fl">1.0</span> <span class="op">-</span> ϵ) <span class="op">*</span> P0</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>        Pstar1 <span class="op">=</span> ϵ <span class="op">*</span> Pstarprime1 <span class="op">+</span> (<span class="fl">1.0</span> <span class="op">-</span> ϵ) <span class="op">*</span> Pstar0</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>        distance <span class="op">=</span> <span class="fu">max</span>(<span class="fu">abs</span>(P1 <span class="op">-</span> P0), <span class="fu">abs</span>(Pstar1 <span class="op">-</span> Pstar0))</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>        (distance <span class="op">&lt;</span> tol <span class="op">||</span> iter <span class="op">==</span> <span class="fl">2000</span>) <span class="op">&amp;&amp;</span> <span class="cf">break</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>        P0 <span class="op">=</span> <span class="fu">copy</span>(P1)</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>        Pstar0 <span class="op">=</span> <span class="fu">copy</span>(Pstar1)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> P1, Pstar1, ind_p_mat, ind_pstar_mat, sol, pdf, iter</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>compute_stationary_equilibrium (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-50" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="cf">begin</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    P_rce, Pstar_rce, ind_p_mat_rce, ind_pstar_mat_rce, sol_rce, pdf_rce, iter_rce <span class="op">=</span> <span class="fu">compute_stationary_equilibrium</span>(E)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.416649 seconds (254.81 k allocations: 91.882 MiB, 2.54% gc time)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(0.01595205933641332, 0.021695700591961128, [0.30768588844713596 0.30768588844713596 0.30768588844713596; 0.30220639279011097 0.30220639279011097 0.30220639279011097; … ; 0.052883757118820714 0.052883757118820714 0.052883757118820714; 0.05194196443888268 0.05194196443888268 0.05194196443888268], [-1.0 0.4922974215154175 0.36922306613656314; -1.0 0.4835302284641776 0.3626476713481332; … ; -1.0 0.08461401139011314 0.06346050854258485; -1.0 0.08310714310221229 0.062330357326659216], (vNX = [2.6845862763859143e-5; 2.7012079309207837e-5; … ; 0.0001826363856354905; 0.00018807831253375335;;], vEX = [2.6857343001530896e-5 2.6882145984155057e-5; 2.7024415088905326e-5 2.7051066464794964e-5; … ; 0.0002016186436944281 0.0002742056298972245; 0.00020817529306058711 0.00028429120581876285], polNX = [0; 0; … ; 1; 1;;], polEX = [0 0; 0 0; … ; 1 1; 1 1], Π = [0.2355397082043846 0.0398220365205688 … 0.0 0.0; 0.2035639923092491 0.03686888293414207 … 0.0 0.0; … ; 4.784202347164862e-30 1.4778853656337744e-29 … 0.03686888293414202 0.20356399230924901; 1.3827115757372961e-30 4.347177100735715e-30 … 0.039822036520568704 0.23553970820438463], ϵ_vec = [0.4908675431085489, 0.4979749102029403, 0.5051851862545925, 0.5124998613024105, 0.5199204469598645, 0.5274484767273707, 0.5350855063091983, 0.5428331139349621, 0.5506929006857724, 0.5586664908251056  …  1.7899766970506505, 1.8158941194896647, 1.84218680535361, 1.8688601881549594, 1.8959197800790755, 1.9233711731233287, 1.9512200402527142, 1.9794721365721941, 2.0081333005160213, 2.0372094550542794], iter = 37), [0.001099533362581301 4.863113223732801e-6 5.264581886217994e-5; 0.0002765981598866844 2.0442021739576122e-6 2.115811823782667e-5; … ; 1.0871545107504635e-11 0.00015613753141058758 0.00014366293801633918; 9.50637483804308e-12 0.0006012986410113883 0.0005557436441494431], 35)</code></pre>
</div>
</div>
<p><strong>Just look at the insane speed</strong>. Remember we didn’t do any parallelization and stuff. These are just very efficient codes.</p>
</section>
<section id="some-results-from-the-stationary-equilibrium" class="level4">
<h4 class="anchored" data-anchor-id="some-results-from-the-stationary-equilibrium">6.6 Some results from the stationary equilibrium</h4>
<p>Share of firms in each state</p>
<div id="cell-53" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>NX_share, EX_low_share, EX_high_share <span class="op">=</span> <span class="fu">sum</span>(pdf_rce, dims <span class="op">=</span> <span class="fl">1</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"The share of nonexporters is </span><span class="sc">$</span>NX_share<span class="st">, the share of exporters with low technology is </span><span class="sc">$</span>EX_low_share<span class="st">, the share of exporters with high technology is </span><span class="sc">$</span>EX_high_share<span class="st">, in the stationary distribution, "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The share of nonexporters is 0.19266736559312644, the share of exporters with low technology is 0.4157090422674407, the share of exporters with high technology is 0.391623592139432, in the stationary distribution, </code></pre>
</div>
</div>
<p>Cutoff productivity for firms at different states.</p>
<div id="cell-55" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find_cutoff_prod</span>(sol_rce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3-element Vector{Float64}:
 1.036592023817942
 0.7555421023503837
 0.5749616962539099</code></pre>
</div>
</div>
<p>We can collect some moments from the stationary distribution. They will be useful for estimations.</p>
<div id="cell-57" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">moments_fixedQ</span>(P, Pstar, sol, pdf, ind_p_mat, ind_pstar_mat; E <span class="op">=</span> E, Qvalue <span class="op">=</span> E.Q, τ <span class="op">=</span> <span class="fl">0.0</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    (;ρϵ, σϵ, grids, ξ) <span class="op">=</span> E</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    Π, ϵ_vec <span class="op">=</span> <span class="fu">tauchen</span>(grids, ρϵ, σϵ)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exporter share</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    exporter_share <span class="op">=</span> <span class="fu">sum</span>(pdf, dims <span class="op">=</span> <span class="fl">1</span>)[<span class="fl">1</span>]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># starter rate</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    starter_rate <span class="op">=</span> sol.polNX<span class="op">⋅</span>pdf[<span class="op">:</span>,<span class="fl">1</span>]</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># stopper rate (should be same as starter rate under stationary equilibrium)</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    stopper_rate <span class="op">=</span> (<span class="fl">1</span> <span class="op">.-</span> sol.polEX)<span class="op">⋅</span>pdf[<span class="op">:</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>]</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exporter sales ratio conditional on exporting</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    sales_EX_do <span class="op">=</span> <span class="fu">zeros</span>(<span class="fu">eltype</span>(P), grids, <span class="fu">length</span>(ξ))</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    sales_EX_fo <span class="op">=</span> <span class="fu">similar</span>(sales_EX_do)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    accum <span class="op">=</span> <span class="fu">zero</span>(<span class="fu">eltype</span>(P))</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>grids</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(ξ)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>               sales_EX_do[i, j], sales_EX_fo[i, j]  <span class="op">=</span> <span class="fu">sales</span>(<span class="fl">1</span>, ϵ_vec[i], j, P, Pstar; E<span class="op">=</span> E, Qvalue <span class="op">=</span> Qvalue, τ <span class="op">=</span> τ)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>               accum <span class="op">+=</span> sales_EX_fo[i, j]<span class="op">/</span>(sales_EX_do[i, j] <span class="op">+</span> sales_EX_fo[i, j]) <span class="op">*</span> pdf[i, j<span class="op">+</span><span class="fl">1</span>]<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>exporter_share )</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average export price (in domestic currency) and domestic price ratio conditional on exporting</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    fo_price_ratio <span class="op">=</span> <span class="fu">sum</span>(Qvalue<span class="op">.*</span>ind_pstar_mat[<span class="op">:</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>]<span class="op">./</span>ind_p_mat[<span class="op">:</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>]<span class="op">.*</span>pdf_rce[<span class="op">:</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">3</span>])<span class="op">/</span>(<span class="fl">1.0</span><span class="op">-</span>exporter_share)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> exporter_share, starter_rate, stopper_rate, accum, fo_price_ratio </span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>moments_fixedQ (generic function with 1 method)</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">moments_fixedQ</span>(P_rce, Pstar_rce, sol_rce, pdf_rce, ind_p_mat_rce, ind_pstar_mat_rce)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(0.19266736559312644, 0.01391198296999171, 0.013911817889600284, 0.46736658942224996, 1.4059666732401315)</code></pre>
</div>
</div>
<p>Note that by optimality condition of an exporting firm. <span class="math inline">\(Q p_j^* /p_j = \frac{\xi}{1 - \tau}\)</span>, so the last moment, the average export price ratio conditional on exporting can also be computed from the the parameter values of <span class="math inline">\(\xi\)</span> and <span class="math inline">\(\tau\)</span> and the conditional fraction of exporters at different states of <span class="math inline">\(\xi\)</span>. This moment can be interpreted as a premium for exporting.</p>
<p>Play with it and try with different parameters. How does the steady state equilibrium change?</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>